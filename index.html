<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Trabajo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- Variables de Color --- */
        :root {
            --bg-color-soft: #f8fafc;
            /* Colores originales para estados */
            --color-td: #f59e0b; /* Amarillo sol */
            --color-tn: #4b5563; /* Gris/Azul noche */
            --color-l: #22c55e;  /* Verde casa */
            --color-vac: #0ea5e9; /* Azul claro avión */
            --color-hotel: #a855f7; /* Púrpura hotel */
            --color-flag-sk-blue: #0b4ea2; /* Azul bandera SK */
            --color-flag-sk-red: #ee1c25;  /* Rojo bandera SK */
            --color-default-icon2: #8b5cf6; /* Morado para segunda casa */
            --color-current-day-border: #3b82f6; /* Azul para día actual */
        }

        /* --- Estilos Generales --- */
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color-soft); margin: 0; min-height: 100vh; }
        .button { padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .button:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .button-primary { background-color: #4a5568; color: white; }
        .button-primary:hover { background-color: #2d3748; }
        .button-secondary { background-color: white; color: #4b5563; border-color: #d1d5db; }
        .button-secondary:hover { background-color: #f9fafb; }

        /* --- Aplicación Principal --- */
        #calendar-app { max-width: 1600px; margin: 0 auto; padding: 1rem 0; }

        /* --- Controles Superiores --- */
        .controls-container { display: flex; justify-content: center; padding: 1rem 2rem; margin-bottom: 1.5rem; background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); max-width: calc(1600px - 4rem); margin-left: auto; margin-right: auto; }
        .year-navigation { display: flex; align-items: center; gap: 0.8rem; }
        #current-year { font-size: 1.5rem; font-weight: bold; color: #1f2937; min-width: 80px; text-align: center; }

        /* --- Calendario Anual --- */
        .calendar-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; padding: 0 2rem 2rem 2rem; }
        .month { border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .month:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        .month-header { background-color: #6b7280; color: white; padding: 0.4rem; text-align: center; font-weight: 600; font-size: 0.9rem; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; padding: 0.2rem; }
        .day-header { font-weight: 600; font-size: 0.9rem; color: #6b7280; padding-bottom: 0.2rem; }
        .day { padding: 0.8rem; font-size: 1rem; border-top: 1px solid #f3f4f6; position: relative; display: flex; align-items: center; justify-content: center; border-radius: 0.25rem; background-color: #ffffff; min-height: 40px; }
        .day.empty { background-color: #f9fafb; border-top: none; }
        .day span { position: absolute; top: 2px; right: 2px; background-color: rgba(255, 255, 255, 0.7); border-radius: 50%; padding: 0 2px; font-size: 0.6rem; z-index: 2; color: #374151; font-weight: normal; }
        .day.current-day { border: 1.5px solid var(--color-current-day-border); font-weight: bold; }
        
        /* Iconos en vista anual */
        .day .icon-container { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; position: relative; }
        .day .icon-container .main-icon-wrapper  /* Contenedor icono 1 */ 
        .day .icon-container .main-icon { font-size: 0.9rem; z-index: 1; }
        .day .icon-container .main-icon.fa-sun { color: var(--color-td); }
        .day .icon-container .main-icon.fa-moon { color: var(--color-tn); }
        .day .icon-container .main-icon.fa-house { color: var(--color-l); }
        .day .icon-container .main-icon.fa-plane { color: var(--color-vac); }
        .day .icon-container .main-icon.fa-hotel { color: var(--color-hotel); }
        
        /* Indicador si icono 2 tiene override */
        .day .secondary-indicator-wrapper  /* Contenedor indicador */ 
        .day .secondary-indicator { position: absolute; bottom: 2px; left: 5px; width: 6px; height: 6px; border-radius: 50%; z-index: 1; border: 1px solid white; background-color: var(--color-default-icon2); }

        /* --- Modal Mes Grande --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 0; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); position: relative; width: 95%; max-width: 800px; transform: scale(0.95); transition: transform 0.3s ease; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; position: relative; display: flex; justify-content: center; align-items: center; }
        .modal-title { font-size: 1.5rem; font-weight: bold; color: #1f2937; }
        .modal-close-btn { position: absolute; top: 50%; right: 1rem; transform: translateY(-50%); background: none; border: none; font-size: 1.8rem; color: #6b7280; cursor: pointer; line-height: 1; padding: 0.25rem; }
        .modal-close-btn:hover { color: #1f2937; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        
        /* Grid del mes en modal */
        .modal-days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; }
        .modal-day-header { font-weight: bold; font-size: 0.9rem; color: #6b7280; padding-bottom: 0.5rem; text-align: center; }
        
        /* Celda día modal */
        .modal-day {
            min-height: 70px;
            border: 1px solid #e5e7eb; border-radius: 0.5rem; position: relative;
            padding: 0.5rem; background-color: #f8f8f8; cursor: pointer;
            transition: background-color 0.2s; overflow: hidden;
        /* FIX ICONOS LADO A LADO: Usar flex para controlar el layout interno */
            display: flex;
            align-items: center; /* Centrar verticalmente el contenedor de iconos */
            justify-content: flex-start; /* Alinear contenedor de iconos a la izquierda */
        }
        .modal-day:hover { background-color: #f0f0f0; }
        .modal-day.empty { background-color: #f9fafb; border-color: #f9fafb; cursor: default; }
        /* Número día modal (Esquina superior derecha) */
        .modal-day span {
            position: absolute; top: 4px; right: 5px;
            font-size: 0.8rem; font-weight: bold; color: #374151;
            background-color: rgba(255, 255, 255, 0.7); padding: 1px 4px;
            border-radius: 50%; z-index: 2;
        }
        /* FIX ICONOS LADO A LADO: Contenedor principal de iconos */
        .modal-day .icons-wrapper {
            display: flex; /* Poner wrappers de iconos en fila */
            flex-direction: row; /* Asegurar dirección horizontal */
            align-items: center; /* Alinear verticalmente */
            justify-content: flex-start; /* Alinear a la izquierda */
            gap: 0.6rem; /* Espacio entre los dos iconos */
            width: auto; /* Ajustar al contenido */
            padding-left: 5px; /* Pequeño margen izquierdo general */
            /* Quitar posicionamiento absoluto, ahora es controlado por flex */
            position: static;
            transform: none;
            height: auto;
            z-index: 1;
        }
        /* FIX ICONOS LADO A LADO: Wrapper para cada icono individual */
        .modal-day .status-icon-wrapper {
             /* Quitar posicionamiento absoluto */
             position: static;
             line-height: 1;
             display: flex;
             align-items: center;
             justify-content: center;
             width: auto;
             /* Quitar top/bottom */
        }
        
        /* Wrapper BASE para cada icono individual */
        /*.modal-day .status-icon-wrapper {
             /*position: absolute; left: 7px;
             /*line-height: 1; display: flex; align-items: center; justify-content: center;
             /*width: auto; z-index: 1;}
        /* Posición específica para icono 1 (arriba) */
        /*.modal-day .status-icon-wrapper-1 { top: 2px; }
        /* Posición específica para icono 2 (abajo) */
        /*.modal-day .status-icon-wrapper-2 { bottom: 2px; }

        /* Tamaño iconos */
        .modal-day .status-icon { font-size: 1.2rem; }
        
        /* Colores originales para iconos en modal */
        .modal-day .status-icon-wrapper .fa-sun { color: var(--color-td); }
        .modal-day .status-icon-wrapper .fa-moon { color: var(--color-tn); }
        .modal-day .status-icon-wrapper .fa-house { color: var(--color-l); }
        .modal-day .status-icon-wrapper .fa-house.icon2-default { color: var(--color-default-icon2); }
        .modal-day .status-icon-wrapper .fa-plane { color: var(--color-vac); }
        .modal-day .status-icon-wrapper .fa-hotel { color: var(--color-hotel); }
        .modal-day .status-icon-wrapper .flag-sk-svg { width: 1.6em; height: 1.1em; }

        .modal-day.current-day { border: 2px solid var(--color-current-day-border); font-weight: bold; }

        /* --- Modal Editor de Día --- */
        #day-editor-modal .modal-content { max-width: 550px; }
        #day-editor-modal .modal-body { display: flex; flex-direction: column; gap: 1.5rem; }
        .editor-section { border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.5rem; }
        .editor-section h3 { font-weight: 600; margin-bottom: 0.8rem; color: #374151; }
        .status-selection { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem; }
        .status-option { display: flex; flex-direction: column; align-items: center; gap: 0.3rem; padding: 0.8rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; text-align: center; }
        .status-option:hover { background-color: #f3f4f6; }
        .status-option.selected { border-color: var(--color-current-day-border); background-color: #e0f2fe; font-weight: 600; }
        .status-option i, .status-option svg { font-size: 1.8rem; margin-bottom: 0.2rem; width: 1.8rem; height: 1.2rem; }
        .status-option span { font-size: 0.8rem; color: #374151; }
        .status-option.clear-option { border-style: dashed; }
        .status-option.clear-option i { color: #9ca3af; }
        .status-option .fa-plane { color: var(--color-vac); }
        .status-option .fa-hotel { color: var(--color-hotel); }
        .status-option .flag-sk-svg  /* Estilos específicos si son necesarios */ 
        #day-editor-modal .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.5rem; background-color: #f9fafb; }

    </style>
</head>
<body>
    <div id="calendar-app">
        <div class="controls-container">
            <div class="year-navigation">
                <button id="prev-year" class="button button-secondary" aria-label="Año anterior"><i class="fas fa-chevron-left"></i></button>
                <span id="current-year" aria-live="polite">2025</span>
                <button id="next-year" class="button button-secondary" aria-label="Año siguiente"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        <div id="calendar-container" class="calendar-container"></div>
    </div>

    <div id="month-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                 <h2 id="modal-title" class="modal-title">Mes</h2>
                 <button id="month-modal-close-btn" class="modal-close-btn" aria-label="Cerrar modal">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                </div>
        </div>
    </div>

    <div id="day-editor-modal" class="modal-overlay">
         <div class="modal-content">
             <div class="modal-header">
                 <h2 id="day-editor-title" class="modal-title">Editar Día</h2>
                 <button id="day-editor-close-btn" class="modal-close-btn" aria-label="Cerrar editor">&times;</button>
             </div>
             <div id="day-editor-body" class="modal-body">
                 <div class="editor-section">
                     <h3>Calendario Yei(Horario Base)</h3>
                     <div id="status-selection-1" class="status-selection">
                         </div>
                 </div>
                  <div class="editor-section">
                     <h3>Calendario Mariana (Extra)</h3>
                     <div id="status-selection-2" class="status-selection">
                         </div>
                 </div>
             </div>
              <div class="modal-footer">
                  <button id="day-editor-cancel" class="button button-secondary">Cancelar</button>
                  <button id="day-editor-save" class="button button-primary">Guardar</button>
              </div>
         </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // --- Elementos DOM ---
        const calendarAppDiv = document.getElementById('calendar-app');
        const calendarContainer = document.getElementById('calendar-container');
        const currentYearSpan = document.getElementById('current-year');
        const prevYearBtn = document.getElementById('prev-year');
        const nextYearBtn = document.getElementById('next-year');
        const monthModal = document.getElementById('month-modal');
        const monthModalTitle = document.getElementById('modal-title');
        const monthModalBody = document.getElementById('modal-body');
        const monthModalCloseBtn = document.getElementById('month-modal-close-btn');
        const dayEditorModal = document.getElementById('day-editor-modal');
        const dayEditorTitle = document.getElementById('day-editor-title');
        const dayEditorBody = document.getElementById('day-editor-body');
        const statusSelectionDiv1 = document.getElementById('status-selection-1');
        const statusSelectionDiv2 = document.getElementById('status-selection-2');
        const dayEditorSaveBtn = document.getElementById('day-editor-save');
        const dayEditorCancelBtn = document.getElementById('day-editor-cancel');
        const dayEditorCloseBtn = document.getElementById('day-editor-close-btn');

        // --- Estado de la Aplicación ---
        let displayedYear = new Date().getFullYear();
        let dayData = {}; // { "YYYY-MM-DD": { icon1: '...', icon2: '...' } }
        let selectedDateForEdit = null;
        const today = new Date();
        today.setHours(0,0,0,0);

        // --- Constantes y Configuración ---
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const dayNames = ["Lu", "Ma", "Mi", "Ju", "Vi", "Sá", "Do"];
        const baseWorkPattern = ['TD', 'TD', 'TD', 'L', 'L', 'TD', 'TD', 'L', 'L', 'L', 'TN', 'TN', 'L', 'L', 'TN', 'TN', 'TN', 'L', 'L', 'TN', 'TN', 'L', 'L', 'L', 'TD', 'TD', 'L', 'L'];
        const patternLength = baseWorkPattern.length;
        const sequenceStartDate = new Date(2025, 0, 3);
        const utcStartDate = new Date(Date.UTC(sequenceStartDate.getFullYear(), sequenceStartDate.getMonth(), sequenceStartDate.getDate()));

        const BASE_STATUS_OPTIONS = {
            'TD': { label: 'Día', icon: 'fa-sun' },
            'TN': { label: 'Noche', icon: 'fa-moon' },
            'L': { label: 'Libre', icon: 'fa-house' }
        };
        const DEFAULT_ICON2_STATUS = 'HOME_PURPLE';
        const DEFAULT_ICON2_OPTIONS = {
             [DEFAULT_ICON2_STATUS]: { label: 'Casa', icon: 'fa-house', class: 'icon2-default' }
        };
        const EXTRA_STATUS_OPTIONS = {
            'VAC': { label: 'Vacaciones', icon: 'fa-plane' },
            'HOTEL': { label: 'Hotel', icon: 'fa-hotel' },
            'FLAG_SK': { label: 'Eslovaquia', icon: 'flag-sk-svg' }
        };
        const FLAG_SK_SVG = `<svg class="flag-sk-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 9 6"><path fill="#fff" d="M0 0h9v6H0z"/><path fill="var(--color-flag-sk-blue)" d="M0 2h9v4H0z"/><path fill="var(--color-flag-sk-red)" d="M0 4h9v2H0z"/><g transform="translate(2.75 1.5) scale(.0625)"><path fill="#fff" d="M16 0c-8.837 0-16 7.163-16 16s7.163 16 16 16 16-7.163 16-16S24.837 0 16 0z"/><path fill="var(--color-flag-sk-blue)" d="M16 4.445c-6.375 0-11.555 5.18-11.555 11.555S9.625 27.555 16 27.555 27.555 22.375 27.555 16 22.375 4.445 16 4.445z"/><path fill="#fff" d="M16 10h-4v4h4v4h4v-4h4v-4h-4z"/><path fill="var(--color-flag-sk-red)" d="M16 11h-3v3h3v3h2v-3h3v-3h-3z"/></g></svg>`;

        // --- Configuración de Firebase ---
        // ** IMPORTANTE: Reemplaza esto con la configuración de tu proyecto Firebase **
        const firebaseConfig = {
            apiKey: "AIzaSyD0zentUNqgouFTVD3i3wKLruRQkgMZt_Y",
            authDomain: "calentonqui.firebaseapp.com",
            databaseURL: "https://calentonqui-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "calentonqui",
            storageBucket: "calentonqui.firebasestorage.app",
            messagingSenderId: "386155002525",
            appId: "1:386155002525:web:75a074d782f07e285a7274"
            };

        // --- Inicialización de Firebase ---
        let app;
        let db;
        let calendarRef; // Referencia a la base de datos para el año actual

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase inicializado correctamente.");
        } catch (error) {
            console.error("Error inicializando Firebase:", error);
            alert("Error conectando con la base de datos. El calendario no funcionará online.");
            // Podríamos deshabilitar botones o mostrar un mensaje permanente
        }

        // --- Funciones de Base de Datos Firebase ---

        // ** MODIFICADO: Cargar datos desde Firebase **
        function loadData(year) {
            console.log(`Intentando cargar datos para el año ${year} desde Firebase...`);
            if (!db) {
                console.error("La base de datos Firebase no está inicializada.");
                dayData = {}; // Usar datos vacíos si no hay conexión
                generateAnnualCalendar(year); // Generar calendario con datos vacíos
                return;
            }
            calendarRef = db.ref(`calendars/${year}`); // Referencia específica del año

            // Escuchar cambios en tiempo real
            calendarRef.on('value', (snapshot) => {
                const dataFromFirebase = snapshot.val();
                dayData = dataFromFirebase || {}; // Usar datos de Firebase o un objeto vacío
                console.log(`Datos recibidos/actualizados para ${year}:`, dayData);
                // Volver a generar el calendario completo o solo actualizar los días afectados
                // Por simplicidad, regeneramos todo el calendario anual al recibir datos
                generateAnnualCalendarUI(year); // Llamar a la función que solo dibuja la UI
            }, (error) => {
                console.error(`Error al leer datos de Firebase para el año ${year}:`, error);
                alert("Error al leer los datos del calendario. Puede que no veas la información más reciente.");
                dayData = {}; // Resetear datos locales en caso de error de lectura
                generateAnnualCalendarUI(year); // Intentar dibujar con datos vacíos
            });
        }

        // ** MODIFICADO: Guardar datos directamente en Firebase **
        function saveDayDataToFirebase(dateString, dayInfo) {
            console.log(`Guardando datos para ${dateString} en Firebase:`, dayInfo);
            if (!db) {
                console.error("No se puede guardar: la base de datos Firebase no está inicializada.");
                alert("Error: No se pudo guardar el cambio. Comprueba la conexión.");
                return;
            }
            // Referencia al día específico dentro del año
            const dayRef = db.ref(`calendars/${displayedYear}/${dateString}`);

            if (Object.keys(dayInfo).length === 0) {
                // Si no hay datos para guardar (se limpiaron ambos iconos), eliminar la entrada del día
                dayRef.remove()
                    .then(() => {
                        console.log(`Datos eliminados para ${dateString}`);
                        // No es necesario re-renderizar aquí si 'onValue' está activo
                    })
                    .catch((error) => {
                        console.error(`Error eliminando datos para ${dateString}:`, error);
                        alert("Error al guardar el cambio (eliminación).");
                    });
            } else {
                // Guardar/actualizar los datos del día
                dayRef.set(dayInfo)
                    .then(() => {
                        console.log(`Datos guardados correctamente para ${dateString}`);
                        // No es necesario re-renderizar aquí si 'onValue' está activo
                    })
                    .catch((error) => {
                        console.error(`Error guardando datos para ${dateString}:`, error);
                        alert("Error al guardar el cambio.");
                    });
            }
        }

        // --- Lógica Horario Base (sin cambios) ---
        function getDefaultStatusForDay(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            const currentDate = new Date(Date.UTC(year, month - 1, day));
            if (currentDate >= utcStartDate) {
                const timeDiff = currentDate.getTime() - utcStartDate.getTime();
                const dayDifference = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const patternIndex = dayDifference % patternLength;
                return baseWorkPattern[patternIndex];
            } else { return 'L'; }
        }

        // --- Funciones de Renderizado ---
        function createDayCellHTML(day, monthIndex, year, isModal = false) {
             const date = new Date(year, monthIndex, day); date.setHours(0,0,0,0);
             const dateString = `${year}-${String(monthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
             const isCurrentDay = date.getTime() === today.getTime();
             const cellClass = isModal ? 'modal-day' : 'day';
             let cellHTML = `<div class="${cellClass}${isCurrentDay ? ' current-day' : ''}" data-date="${dateString}">`;
             if (isModal) {
                 cellHTML += `<span>${day}</span><div class="icons-wrapper">`;
                 cellHTML += `<span class="status-icon-wrapper status-icon-wrapper-1"></span>`;
                 cellHTML += `<span class="status-icon-wrapper status-icon-wrapper-2"></span>`;
                 cellHTML += `</div>`;
             } else {
                 cellHTML += `<span>${day}</span><div class="icon-container"><span class="main-icon-wrapper"></span><span class="secondary-indicator-wrapper"></span></div>`;
             }
             cellHTML += `</div>`; return cellHTML;
        }

        function applyDayMarkings(dayCell) {
            try {
                const dateString = dayCell.dataset.date;
                if (!dateString) return;
                // ** Usar dayData global que se actualiza con onValue **
                const dayInfo = dayData[dateString] || {};
                const isModal = dayCell.classList.contains('modal-day');

                const defaultStatusIcon1 = getDefaultStatusForDay(dateString);
                const defaultStatusIcon2 = DEFAULT_ICON2_STATUS;
                const finalStatusIcon1 = dayInfo.icon1 || defaultStatusIcon1;
                const finalStatusIcon2 = dayInfo.icon2 || defaultStatusIcon2;

                let icon1Info = EXTRA_STATUS_OPTIONS[finalStatusIcon1] || BASE_STATUS_OPTIONS[finalStatusIcon1];
                let icon2Info = EXTRA_STATUS_OPTIONS[finalStatusIcon2] || DEFAULT_ICON2_OPTIONS[finalStatusIcon2];

                if (isModal) {
                    const iconWrapper1 = dayCell.querySelector('.status-icon-wrapper-1');
                    const iconWrapper2 = dayCell.querySelector('.status-icon-wrapper-2');

                    if (iconWrapper1) {
                        iconWrapper1.innerHTML = '';
                        if (icon1Info) {
                            const titleText = icon1Info.label || 'Icono 1';
                            if (finalStatusIcon1 === 'FLAG_SK') {
                                iconWrapper1.innerHTML = FLAG_SK_SVG;
                            } else {
                                iconWrapper1.innerHTML = `<i class="fas ${icon1Info.icon} status-icon ${icon1Info.class || ''}" title="${titleText}"></i>`;
                            }
                        }
                    } else { console.warn("Icon wrapper 1 no encontrado", dayCell); }

                    if (iconWrapper2) {
                        iconWrapper2.innerHTML = '';
                        if (icon2Info) {
                             const titleText = icon2Info.label || 'Icono 2';
                             if (finalStatusIcon2 === 'FLAG_SK') {
                                 iconWrapper2.innerHTML = FLAG_SK_SVG;
                             } else {
                                 iconWrapper2.innerHTML = `<i class="fas ${icon2Info.icon} status-icon ${icon2Info.class || ''}" title="${titleText}"></i>`;
                             }
                        }
                    } else { console.warn("Icon wrapper 2 no encontrado", dayCell); }

                } else {
                    const mainIconWrapper = dayCell.querySelector('.main-icon-wrapper');
                    const secondaryIndicatorWrapper = dayCell.querySelector('.secondary-indicator-wrapper');

                    if (mainIconWrapper) {
                        mainIconWrapper.innerHTML = '';
                        if (icon1Info) {
                            const titleText = icon1Info.label || 'Icono 1';
                             if (finalStatusIcon1 === 'FLAG_SK') {
                                 mainIconWrapper.innerHTML = `<i class="fas fa-flag main-icon" title="${titleText}"></i>`;
                             } else {
                                 mainIconWrapper.innerHTML = `<i class="fas ${icon1Info.icon} main-icon" title="${titleText}"></i>`;
                             }
                        }
                    } else { console.warn("Main icon wrapper no encontrado", dayCell); }

                    if (secondaryIndicatorWrapper) {
                        secondaryIndicatorWrapper.innerHTML = '';
                        if (dayInfo.icon2) {
                            secondaryIndicatorWrapper.innerHTML = `<span class="secondary-indicator" title="Estado extra añadido"></span>`;
                        }
                    } else { console.warn("Secondary indicator wrapper no encontrado", dayCell); }
                }
            } catch (error) {
                 console.error(`Error general en applyDayMarkings para celda ${dayCell?.dataset?.date}:`, error, error.stack, dayCell);
            }
        }


        function generateSingleMonthGrid(year, monthIndex) {
             let gridHTML = `<div class="modal-days-grid">`;
             dayNames.forEach(dayName => { gridHTML += `<div class="modal-day-header">${dayName}</div>`; });
             const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
             const firstDayOfMonth = new Date(year, monthIndex, 1).getDay();
             const offset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
             for (let i = 0; i < offset; i++) { gridHTML += `<div class="modal-day empty"></div>`; }
             for (let day = 1; day <= daysInMonth; day++) {
                 gridHTML += createDayCellHTML(day, monthIndex, year, true);
             }
             gridHTML += `</div>`;
             const tempDiv = document.createElement('div');
             tempDiv.innerHTML = gridHTML;
             return tempDiv.firstElementChild;
        }

        // ** MODIFICADO: Separar generación de UI de carga de datos **
        function generateAnnualCalendarUI(year) {
            console.log("Generando UI del calendario para el año:", year);
            calendarContainer.innerHTML = ''; // Limpiar contenedor principal
            currentYearSpan.textContent = year; // Actualizar año en UI

            let calendarHTML = '';
            for (let monthIndex = 0; monthIndex < 12; monthIndex++) {
                calendarHTML += `<div class="month" data-month="${monthIndex}" data-year="${year}"><div class="month-header">${monthNames[monthIndex]}</div><div class="days-grid">`;
                dayNames.forEach(dayName => { calendarHTML += `<div class="day-header">${dayName.charAt(0)}</div>`; });
                const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                const firstDayOfMonth = new Date(year, monthIndex, 1).getDay();
                const offset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                for (let i = 0; i < offset; i++) { calendarHTML += `<div class="day empty"></div>`; }
                for (let day = 1; day <= daysInMonth; day++) {
                    calendarHTML += createDayCellHTML(day, monthIndex, year, false);
                 }
                calendarHTML += `</div></div>`;
            }
            calendarContainer.innerHTML = calendarHTML;

            // Aplicar marcadores usando los datos actuales (dayData)
            if (calendarContainer.childElementCount > 0) {
                 console.log("Aplicando marcadores a la vista anual...");
                 calendarContainer.querySelectorAll('.day[data-date]').forEach(applyDayMarkings);
                 console.log("Marcadores aplicados a la vista anual.");
            }
        }

        function populateDayEditor(dateString) {
            selectedDateForEdit = dateString;
            // Usar dayData global que se actualiza con onValue
            const dayInfo = dayData[dateString] || {};
            const currentStatusIcon1 = dayInfo.icon1;
            const currentStatusIcon2 = dayInfo.icon2;
            const dateObj = new Date(dateString + 'T00:00:00');
            dayEditorTitle.textContent = `Editar ${dateObj.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })}`;

            // --- Rellenar sección Icono 1 ---
            statusSelectionDiv1.innerHTML = '';
            Object.entries(EXTRA_STATUS_OPTIONS).forEach(([code, { label, icon }]) => {
                const isSelected = currentStatusIcon1 === code;
                let iconHTML = icon === 'flag-sk-svg' ? FLAG_SK_SVG : `<i class="fas ${icon}"></i>`;
                statusSelectionDiv1.innerHTML += `<div class="status-option ${isSelected ? 'selected' : ''}" data-status="${code}">${iconHTML}<span>${label}</span></div>`;
            });
            const clearSelected1 = !currentStatusIcon1;
            statusSelectionDiv1.innerHTML += `<div class="status-option clear-option ${clearSelected1 ? 'selected' : ''}" data-status=""><i class="fas fa-eraser"></i><span>Limpiar (Base)</span></div>`;

            // --- Rellenar sección Icono 2 ---
            statusSelectionDiv2.innerHTML = '';
            Object.entries(EXTRA_STATUS_OPTIONS).forEach(([code, { label, icon }]) => {
                const isSelected = currentStatusIcon2 === code;
                 let iconHTML = icon === 'flag-sk-svg' ? FLAG_SK_SVG : `<i class="fas ${icon}"></i>`;
                statusSelectionDiv2.innerHTML += `<div class="status-option ${isSelected ? 'selected' : ''}" data-status="${code}">${iconHTML}<span>${label}</span></div>`;
            });
            const clearSelected2 = !currentStatusIcon2;
            statusSelectionDiv2.innerHTML += `<div class="status-option clear-option ${clearSelected2 ? 'selected' : ''}" data-status=""><i class="fas fa-eraser"></i><span>Limpiar (Casa)</span></div>`;


            // --- Añadir listeners a AMBAS secciones ---
             document.querySelectorAll('.status-option').forEach(option => {
                 option.addEventListener('click', (e) => {
                     const section = e.currentTarget.closest('.status-selection');
                     section.querySelector('.selected')?.classList.remove('selected');
                     e.currentTarget.classList.add('selected');
                 });
             });
        }

        // --- Handlers de Eventos ---
        prevYearBtn.addEventListener('click', () => {
             displayedYear--;
             loadData(displayedYear); // Cargar datos para el nuevo año
        });
        nextYearBtn.addEventListener('click', () => {
             displayedYear++;
             loadData(displayedYear); // Cargar datos para el nuevo año
        });

        // Abrir Modal Mes
        calendarContainer.addEventListener('click', (event) => {
            const monthDiv = event.target.closest('.month');
            if (!monthDiv) return;

            const currentMonthModal = document.getElementById('month-modal');
            const currentMonthModalTitle = document.getElementById('modal-title');
            const currentModalBody = document.getElementById('modal-body');
            if (!currentMonthModal || !currentMonthModalTitle || !currentModalBody) { console.error("CRITICAL: Modal elements not found!"); return; }

            try {
                const monthIndex = parseInt(monthDiv.dataset.month);
                const year = parseInt(monthDiv.dataset.year);
                if (isNaN(monthIndex) || isNaN(year)) { console.error("Invalid month/year"); return; }

                currentMonthModalTitle.textContent = `${monthNames[monthIndex]} ${year}`;
                currentModalBody.innerHTML = '';
                const monthGridElement = generateSingleMonthGrid(year, monthIndex);

                if (monthGridElement instanceof Node) {
                    currentModalBody.appendChild(monthGridElement);
                    // ** Usar los datos actuales (dayData) para marcar los días **
                    const modalDays = currentModalBody.querySelectorAll('.modal-day[data-date]');
                    if (modalDays) {
                         modalDays.forEach(applyDayMarkings);
                    }
                    currentMonthModal.classList.add('visible');
                } else { console.error("generateSingleMonthGrid failed"); }
            } catch (error) { console.error("Error opening month modal:", error, error.stack); }
        });


        // Cerrar Modal Mes
        monthModalCloseBtn.addEventListener('click', () => {
             const currentMonthModal = document.getElementById('month-modal');
             if (currentMonthModal) currentMonthModal.classList.remove('visible');
        });
        monthModal.addEventListener('click', (event) => {
             if (event.target === document.getElementById('month-modal')) {
                 document.getElementById('month-modal').classList.remove('visible');
             }
        });


        // Abrir Modal Editor Día
        monthModalBody.addEventListener('click', (event) => {
             const currentDayEditorModal = document.getElementById('day-editor-modal');
             if (!currentDayEditorModal) { console.error("Error: Editor modal element not found."); return; }
             const dayDiv = event.target.closest('.modal-day:not(.empty)');
             if (dayDiv) {
                 const dateString = dayDiv.dataset.date;
                 populateDayEditor(dateString);
                 currentDayEditorModal.classList.add('visible');
             }
        });


        // ** MODIFICADO: Guardar Cambios Editor Día usando Firebase **
        dayEditorSaveBtn.addEventListener('click', () => {
            const currentDayEditorModal = document.getElementById('day-editor-modal');
            if (!currentDayEditorModal) { console.error("Error: dayEditorModal not available on save."); return; }
            if (!selectedDateForEdit) { console.error("Error: No date selected for saving."); return; }

            const selectedStatusOption1 = statusSelectionDiv1.querySelector('.status-option.selected');
            const selectedStatusOption2 = statusSelectionDiv2.querySelector('.status-option.selected');

            const newStatus1 = selectedStatusOption1 ? selectedStatusOption1.dataset.status : null;
            const newStatus2 = selectedStatusOption2 ? selectedStatusOption2.dataset.status : null;

            // Crear objeto con los datos a guardar/actualizar
            let dayInfoUpdate = {};
            if (newStatus1 === "") {
                 dayInfoUpdate.icon1 = null; // Usar null para indicar eliminación en Firebase
            } else if (newStatus1 !== null) {
                 dayInfoUpdate.icon1 = newStatus1;
            }

             if (newStatus2 === "") {
                 dayInfoUpdate.icon2 = null; // Usar null para indicar eliminación
            } else if (newStatus2 !== null) {
                 dayInfoUpdate.icon2 = newStatus2;
            }

            // Si ambos son null, significa que queremos borrar la entrada del día
            const shouldDelete = !dayInfoUpdate.icon1 && !dayInfoUpdate.icon2;

            // Llamar a la función para guardar en Firebase
            saveDayDataToFirebase(selectedDateForEdit, shouldDelete ? {} : dayInfoUpdate); // Pasar objeto vacío si se debe eliminar

            // La actualización visual ocurrirá automáticamente gracias al listener 'onValue'
            currentDayEditorModal.classList.remove('visible');
            selectedDateForEdit = null;
        });


        // Cancelar / Cerrar Editor Día
        dayEditorCancelBtn.addEventListener('click', () => {
             const currentDayEditorModal = document.getElementById('day-editor-modal');
             if (currentDayEditorModal) currentDayEditorModal.classList.remove('visible');
        });
        dayEditorCloseBtn.addEventListener('click', () => {
             const currentDayEditorModal = document.getElementById('day-editor-modal');
             if (currentDayEditorModal) currentDayEditorModal.classList.remove('visible');
        });
        dayEditorModal.addEventListener('click', (event) => {
             const currentDayEditorModal = document.getElementById('day-editor-modal');
             if (event.target === currentDayEditorModal) {
                  currentDayEditorModal.classList.remove('visible');
             }
        });


         document.addEventListener('keydown', (event) => {
             const currentDayEditorModal = document.getElementById('day-editor-modal');
             const currentMonthModal = document.getElementById('month-modal');
             if (event.key === 'Escape') {
                 if (currentDayEditorModal && currentDayEditorModal.classList.contains('visible')) {
                      currentDayEditorModal.classList.remove('visible');
                 } else if (currentMonthModal && currentMonthModal.classList.contains('visible')) {
                      currentMonthModal.classList.remove('visible');
                 }
             }
         });

        // --- Inicialización App ---
        function initApp() {
            console.log(`Iniciando calendario simplificado`);
            const essentialElementsExist = calendarAppDiv && calendarContainer && monthModal && dayEditorModal && monthModalBody && statusSelectionDiv1 && statusSelectionDiv2;
            if (!essentialElementsExist) {
                 console.error("Error crítico: Faltan elementos esenciales del DOM al iniciar.");
                 alert("Error: No se pudo iniciar el calendario correctamente.");
                 return;
            }
             console.log("Elemento modalBody encontrado en initApp:", document.getElementById('modal-body'));
            calendarAppDiv.style.display = 'block';
            // ** MODIFICADO: Cargar datos al iniciar **
            loadData(displayedYear); // Carga inicial de datos (esto llamará a generateAnnualCalendarUI)
        }

        // --- Ejecución Inicial ---
        document.addEventListener('DOMContentLoaded', initApp);


    </script>

</body>
</html>
