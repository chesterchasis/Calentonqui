<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #1f2937;
        }
        .app-container { /* Contenedor general para centrar y gestionar la altura */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-container, .calendar-container, .single-month-view-container {
            width: 100%; /* Ocupan todo el ancho del app-container */
            display: flex;
            flex-direction: column;
            align-items: center;
            /* justify-content se maneja por app-container o espec√≠ficamente abajo */
        }
        .single-month-view-container {
            justify-content: flex-start;
            padding-top: 70px; /* Espacio para los controles superiores fijos */
        }
        .calendar-container {
             padding-top: 70px; /* Espacio para los controles superiores fijos */
        }

        .form-card {
            background-color: white;
            padding: 40px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px;
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 8px; padding: 12px 16px;
            width: 100%; margin-bottom: 20px; transition: border-color 0.3s;
            color: #1f2937;
        }
        .input-field::placeholder { color: #9ca3af; }
        .input-field:focus { border-color: #4f46e5; outline: none; }
        .submit-button {
            background-color: #4f46e5; color: white;
            font-weight: 500; padding: 12px 16px; border-radius: 8px; width: 100%;
            transition: background-color 0.3s;
        }
        .submit-button:hover { background-color: #4338ca; }
        .error-message, .info-message {
            font-size: 0.875rem; margin-top: 8px; text-align: center;
        }
        .error-message { color: #ef4444; }
        .info-message { color: #3b82f6; } /* Azul para mensajes informativos */

        .calendar-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px; width: 100%; max-width: 1200px; margin-top: 20px;
        }
        .month-card {
            background-color: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); display: flex; flex-direction: column;
            cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .month-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        .month-header {
            font-size: 1.125rem; font-weight: 600;
            color: #1f2937; margin-bottom: 15px; text-align: center;
        }
        .days-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            gap: 4px; text-align: center; flex-grow: 1;
        }
        .day-name {
            font-size: 0.8rem; padding: 6px 4px; display: flex;
            align-items: center; justify-content: center;
            font-weight: 500; color: #6b7280;
        }
        .day-cell {
            font-size: 0.8rem; padding: 6px 4px; display: flex;
            align-items: center; justify-content: center;
            color: #374151; border-radius: 6px; min-height: 32px;
        }
        .day-cell.empty { background-color: transparent; }
        .day-cell.weekend-day { background-color: #f3f4f6; color: #4b5563; }
        .day-cell.holiday-day { background-color: #fee2e2; color: #b91c1c; font-weight: 500; }
        .day-cell.current-day {
            background-color: #14b8a6 !important; color: white !important;
            font-weight: bold !important; border: 2px solid #0d9488;
        }
        .day-cell.holiday-day.current-day { background-color: #0f766e !important; color: white !important; }

        .year-navigation-container, .single-month-navigation-container {
            display: flex; align-items: center; justify-content: center;
            gap: 1rem; margin-bottom: 1.5rem; width:100%;
            max-width: 900px; margin-left:auto; margin-right:auto;
        }
        .year-navigation-container { margin-bottom: 2rem;}
        .single-month-navigation-container { margin-top: 1rem; }

        .year-nav-button, .month-nav-button {
            background-color: white; border: 1px solid #d1d5db;
            color: #4b5563; border-radius: 50%;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .year-nav-button:hover, .month-nav-button:hover {
            background-color: #f9fafb; border-color: #adb5bd;
            transform: translateY(-1px);
        }
        .year-nav-button svg, .month-nav-button svg { width: 20px; height: 20px; }

        #calendarYearDisplay { font-size: 1.875rem; font-weight: 700; color: #1f2937; }
        #singleMonthYearDisplay { font-size: 1.75rem; font-weight: 600; color: #1f2937; text-align: center; }

        .top-right-controls {
            position: fixed; /* Fijar en la pantalla */
            top: 20px; right: 20px;
            display: flex; z-index: 100; /* Asegurar que est√© por encima de otros elementos */
            gap: 10px;
        }
        .control-button {
            background-color: #4f46e5; color: white;
            font-weight: 500; padding: 0;
            border-radius: 8px; transition: background-color 0.3s;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            border: none; cursor: pointer;
        }
        .control-button:hover { background-color: #4338ca; }
        .control-button svg { width: 20px; height: 20px; }
        #logoutButton.control-button, #logoutButtonSingle.control-button { background-color: #ef4444; }
        #logoutButton.control-button:hover, #logoutButtonSingle.control-button:hover { background-color: #dc2626; }

        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); width: 90%;
            max-width: 700px; max-height: 90vh; overflow-y: auto;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; padding-bottom: 15px;
        }
        .modal-title { font-size: 1.5rem; font-weight: 600; color: #1f2937; }
        .modal-close-button {
            background-color: transparent; border: none; font-size: 1.8rem;
            color: #6b7280; cursor: pointer; padding: 5px; line-height: 1;
        }
        .modal-close-button:hover { color: #1f2937; }

        .modal-days-grid, .single-month-days-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            gap: 8px; text-align: center; width: 100%;
            max-width: 900px; margin: 0 auto;
        }
        .modal-day-name, .single-month-day-name {
            font-size: 0.85rem; font-weight: 500;
            color: #6b7280; padding: 8px 5px; display: flex; align-items: center; justify-content: center;
        }
        .modal-day-cell, .single-month-day-cell {
            position: relative; color: #374151;
            border-radius: 8px; min-height: 80px; padding: 4px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border: 1px solid #e5e7eb; height: auto;
        }
        .modal-day-number, .single-month-day-number {
            position: absolute; top: 3px; right: 5px;
            font-size: 0.7rem; color: #9ca3af; line-height: 1;
        }
        .emoji-display-area {
            display: flex; gap: 6px; align-items: center; justify-content: center;
            width: 100%; flex-grow: 1; margin-top: 5px;
        }
        .emoji-placeholder {
            width: 24px; height: 24px; background-color: #e0e0e0;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: #374151; cursor: pointer;
            transition: background-color 0.2s;
        }
        .emoji-placeholder:hover { background-color: #d1d5db; }
        .emoji-placeholder.has-emoji { background-color: transparent; }

        .modal-day-cell.empty, .single-month-day-cell.empty { background-color: #f9fafb; border-color: #f9fafb; }
        .modal-day-cell.weekend-day, .single-month-day-cell.weekend-day { background-color: #f3f4f6; }
        .modal-day-cell.holiday-day, .single-month-day-cell.holiday-day { background-color: #fee2e2; border-color: #fecaca; }
        .modal-day-cell.holiday-day .modal-day-number,
        .single-month-day-cell.holiday-day .single-month-day-number { color: #b91c1c; }

        .modal-day-cell.current-day, .single-month-day-cell.current-day {
            background-color: #ccfbf1 !important; border-color: #5eead4 !important;
        }
        .modal-day-cell.current-day .modal-day-number,
        .single-month-day-cell.current-day .single-month-day-number { color: #0d9488 !important; font-weight: 600; }
        .modal-day-cell.holiday-day.current-day,
        .single-month-day-cell.holiday-day.current-day { background-color: #fecaca !important; border-color: #f87171 !important; }
        .modal-day-cell.holiday-day.current-day .modal-day-number,
        .single-month-day-cell.holiday-day.current-day .single-month-day-number { color: #b91c1c !important; }

        .emoji-picker-panel {
            position: absolute; background-color: white;
            border: 1px solid #d1d5db; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); padding: 10px;
            display: grid; grid-template-columns: repeat(6, 1fr);
            gap: 8px; z-index: 1001; display: none;
        }
        .emoji-picker-panel span {
            font-size: 20px; cursor: pointer; padding: 4px;
            border-radius: 4px; text-align: center; color: #1f2937;
        }
        .emoji-picker-panel span:hover { background-color: #f3f4f6; }

        /* Checkbox para mantener sesi√≥n */
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .checkbox-container input[type="checkbox"] {
            margin-right: 8px;
            height: 16px; width: 16px;
            border-radius: 4px;
            border-color: #d1d5db;
        }
        .checkbox-container label {
            font-size: 0.875rem;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="loginPage" class="login-container fade-in">
            <div class="form-card">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">CalenTonqui</h1>
                <p class="text-center text-gray-600 mb-8">Inicia sesi√≥n para acceder.</p>
                <form id="loginForm">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="email" name="email" required class="input-field" placeholder="tutonqui@email.com">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                        <input type="password" id="password" name="password" required class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="rememberMe" name="rememberMe">
                        <label for="rememberMe">Mantener la sesi√≥n iniciada</label>
                    </div>
                    <button type="submit" class="submit-button">Iniciar Sesi√≥n</button>
                    <p id="authMessage" class="info-message" style="display: none;"></p> </form>
            </div>
        </div>

        <div id="calendarPage" class="calendar-container" style="display: none;">
            <div class="top-right-controls">
                <button id="toggleViewButton" class="control-button" aria-label="Cambiar Vista">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-3.75h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z" />
                    </svg>
                </button>
                <button id="logoutButton" class="control-button" aria-label="Cerrar Sesi√≥n">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5.636 5.636a9 9 0 1 0 12.728 0M12 3v9" />
                    </svg>
                </button>
            </div>
            <div class="year-navigation-container">
                <button id="prevYearBtn" class="year-nav-button" aria-label="A√±o anterior">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                </button>
                <h1 id="calendarYearDisplay"></h1>
                <button id="nextYearBtn" class="year-nav-button" aria-label="A√±o siguiente">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                </button>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>

        <div id="singleMonthViewPage" class="single-month-view-container" style="display: none;">
            <div class="top-right-controls">
                 <button id="toggleViewButtonSingle" class="control-button" aria-label="Cambiar Vista">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
                <button id="logoutButtonSingle" class="control-button" aria-label="Cerrar Sesi√≥n">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5.636 5.636a9 9 0 1 0 12.728 0M12 3v9" />
                    </svg>
                </button>
            </div>
            <div class="single-month-navigation-container">
                <button id="prevMonthSingleBtn" class="month-nav-button" aria-label="Mes anterior">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                </button>
                <h2 id="singleMonthYearDisplay" class="text-2xl font-semibold"></h2>
                <button id="nextMonthSingleBtn" class="month-nav-button" aria-label="Mes siguiente">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                </button>
            </div>
            <div id="singleMonthCalendarGrid" class="single-month-days-grid"></div>
        </div>

        <div id="monthModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle" class="modal-title"></h2>
                    <button id="modalCloseButton" class="modal-close-button" aria-label="Cerrar modal">&times;</button>
                </div>
                <div id="modalCalendarGrid" class="modal-days-grid"></div>
            </div>
        </div>

        <div id="emojiPickerPanel" class="emoji-picker-panel"></div>
    </div>

    <script>
       const firebaseConfig = {
          apiKey: "AIzaSyD0zentUNqgouFTVD3i3wKLruRQkgMZt_Y",
          authDomain: "calentonqui.firebaseapp.com",
          databaseURL: "https://calentonqui-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "calentonqui",
          storageBucket: "calentonqui.firebasestorage.app",
          messagingSenderId: "386155002525",
          appId: "1:386155002525:web:75a074d782f07e285a7274"
        };
        // // FIREBASE: Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const fbAuth = firebase.auth();
        const fbDb = firebase.firestore();
        let currentUserId = null; // Se establecer√° despu√©s del login

        // Emails permitidos (para la l√≥gica de este ejemplo)
        const allowedEmails = ['berbeci.yeison@gmail.com', 'kortisova.marina@gmail.com'];
        const commonPassword = 'tonqui123'; // Contrase√±a com√∫n para los emails permitidos

        // Elementos del DOM
        const loginPage = document.getElementById('loginPage');
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const rememberMeCheckbox = document.getElementById('rememberMe');
        const authMessage = document.getElementById('authMessage'); // Cambiado de errorMessage a authMessage

        const calendarPage = document.getElementById('calendarPage');
        const calendarGrid = document.getElementById('calendarGrid');
        const calendarYearDisplay = document.getElementById('calendarYearDisplay');
        const prevYearBtn = document.getElementById('prevYearBtn');
        const nextYearBtn = document.getElementById('nextYearBtn');
        const logoutButton = document.getElementById('logoutButton');
        const toggleViewButton = document.getElementById('toggleViewButton');

        const singleMonthViewPage = document.getElementById('singleMonthViewPage');
        const singleMonthYearDisplay = document.getElementById('singleMonthYearDisplay');
        const prevMonthSingleBtn = document.getElementById('prevMonthSingleBtn');
        const nextMonthSingleBtn = document.getElementById('nextMonthSingleBtn');
        const singleMonthCalendarGrid = document.getElementById('singleMonthCalendarGrid');
        const toggleViewButtonSingle = document.getElementById('toggleViewButtonSingle');
        const logoutButtonSingle = document.getElementById('logoutButtonSingle');

        const monthModal = document.getElementById('monthModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalCalendarGrid = document.getElementById('modalCalendarGrid');
        const modalCloseButton = document.getElementById('modalCloseButton');

        const emojiPickerPanel = document.getElementById('emojiPickerPanel');
        const availableEmojis = ['‚òÄÔ∏è', 'üë©üèª‚Äçüíª', 'üòç', 'ü§î', 'üá™üá∏', 'üöÄ', 'üè†', 'üá∏üá∞', 'üòä', 'ü•≥', 'üåü', 'üçï', '‚öΩÔ∏è', '‚úàÔ∏è', 'üåì', 'üìö', '‚ù§Ô∏è', 'üí°', ''];

        const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const diasSemana = ["Lu", "Ma", "Mi", "Ju", "Vi", "S√°", "Do"];

        let currentDisplayedYear = new Date().getFullYear();
        let currentSingleViewYear = new Date().getFullYear();
        let currentSingleViewMonth = new Date().getMonth();

        let dayEmojis = {}; // Local cache for emojis, will be synced with Firestore
        let currentEditingPlaceholder = null;
        let currentEditingDayKey = null;
        let currentEditingPlaceholderKey = null;

        const workSequenceStartDateOriginal = Date.UTC(2025, 0, 3);
        const workSequencePattern = [
            'TD', 'TD', 'TD', 'L',  'L',  'TD', 'TD', 'L',  'L',  'L',
            'TN', 'TN', 'L',  'L',  'TN', 'TN', 'TN', 'L',  'L',  'TN',
            'TN', 'L',  'L',  'L',  'TD', 'TD', 'L',  'L'
        ];
        const workEmojisMap = { 'L': 'üè†', 'TD': '‚òÄÔ∏è', 'TN': 'üåì' };

        const berlinHolidays = {
            2024: [{ month: 0, day: 1, name: "Neujahr" }, { month: 2, day: 8, name: "Internationaler Frauentag" }, { month: 2, day: 29, name: "Karfreitag" }, { month: 3, day: 1, name: "Ostermontag" }, { month: 4, day: 1, name: "Tag der Arbeit" }, { month: 4, day: 9, name: "Christi Himmelfahrt" }, { month: 4, day: 20, name: "Pfingstmontag" }, { month: 9, day: 3, name: "Tag der Deutschen Einheit" }, { month: 11, day: 25, name: "1. Weihnachtsfeiertag" }, { month: 11, day: 26, name: "2. Weihnachtsfeiertag" }],
            2025: [{ month: 0, day: 1, name: "Neujahr" }, { month: 2, day: 8, name: "Internationaler Frauentag" }, { month: 3, day: 18, name: "Karfreitag" }, { month: 3, day: 21, name: "Ostermontag" }, { month: 4, day: 1, name: "Tag der Arbeit" }, { month: 4, day: 8, name: "80. Jahrestag der Befreiung" }, { month: 4, day: 29, name: "Christi Himmelfahrt" }, { month: 5, day: 9, name: "Pfingstmontag" }, { month: 9, day: 3, name: "Tag der Deutschen Einheit" }, { month: 11, day: 25, name: "1. Weihnachtsfeiertag" }, { month: 11, day: 26, name: "2. Weihnachtsfeiertag" }],
            2026: [{ month: 0, day: 1, name: "Neujahr" }, { month: 2, day: 8, name: "Internationaler Frauentag" }, { month: 3, day: 3, name: "Karfreitag" }, { month: 3, day: 6, name: "Ostermontag" }, { month: 4, day: 1, name: "Tag der Arbeit" }, { month: 4, day: 14, name: "Christi Himmelfahrt" }, { month: 4, day: 25, name: "Pfingstmontag" }, { month: 9, day: 3, name: "Tag der Deutschen Einheit" }, { month: 11, day: 25, name: "1. Weihnachtsfeiertag" }, { month: 11, day: 26, name: "2. Weihnachtsfeiertag" }]
        };

        function isHoliday(year, month, day) {
            const holidaysForYear = berlinHolidays[year];
            if (!holidaysForYear) return false;
            return holidaysForYear.some(h => h.month === month && h.day === day);
        }

        /**
         * Muestra un mensaje en el √°rea de autenticaci√≥n.
         * @param {string} message - El mensaje a mostrar.
         * @param {boolean} isError - True si es un mensaje de error, false para informativo.
         */
        function showAuthMessage(message, isError = false) {
            authMessage.textContent = message;
            authMessage.className = isError ? 'error-message' : 'info-message';
            authMessage.style.display = 'block';
        }

        // FIREBASE: Cargar emojis desde Firestore para el usuario actual
        async function loadDayEmojisFromFirestore() {
            if (!currentUserId) return;
            showAuthMessage("Cargando emojis...", false);
            try {
                const emojisSnapshot = await fbDb.collection('users').doc(currentUserId).collection('emojis').get();
                dayEmojis = {}; // Reset local cache
                emojisSnapshot.forEach(doc => {
                    dayEmojis[doc.id] = doc.data();
                });
                showAuthMessage("Emojis cargados.", false);
                setTimeout(() => authMessage.style.display = 'none', 2000);
                // Regenerar la vista actual despu√©s de cargar los emojis
                if (calendarPage.style.display === 'flex') generateCalendar(currentDisplayedYear);
                if (singleMonthViewPage.style.display === 'flex') generateSingleMonthCalendar(currentSingleViewYear, currentSingleViewMonth);

            } catch (error) {
                console.error("Error loading emojis from Firestore: ", error);
                showAuthMessage("Error al cargar emojis.", true);
            }
        }

        // FIREBASE: Guardar emoji para un d√≠a espec√≠fico en Firestore
        async function saveEmojiForDayKeyToFirestore(dayKey, emojiDataForDay) {
            if (!currentUserId || !dayKey) return;
            try {
                if (emojiDataForDay && Object.keys(emojiDataForDay).length > 0) {
                    await fbDb.collection('users').doc(currentUserId).collection('emojis').doc(dayKey).set(emojiDataForDay);
                } else {
                    // Si no hay emojis para ese d√≠a, eliminar el documento de Firestore
                    await fbDb.collection('users').doc(currentUserId).collection('emojis').doc(dayKey).delete();
                }
                // console.log(`Emoji for ${dayKey} saved to Firestore.`);
            } catch (error) {
                console.error("Error saving emoji to Firestore: ", error);
                showAuthMessage("Error al guardar emoji online.", true);
            }
        }


        // --- MANEJADORES DE EVENTOS ---

        loginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            const persistence = rememberMeCheckbox.checked ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;

            if (!allowedEmails.includes(email) || password !== commonPassword) {
                 showAuthMessage('Email o contrase√±a incorrectos para este demo.', true);
                 // En una app real, no dar√≠as esta pista, solo "credenciales incorrectas".
                 // Aqu√≠ es para guiar al usuario a usar los emails permitidos.
                 // Para que funcione con Firebase, estas cuentas deben existir en Firebase Auth.
                 if (!allowedEmails.includes(email)) {
                    console.warn(`Intento de login con email no permitido: ${email}. Aseg√∫rate de que ${email} (con contrase√±a 'tonqui') existe en tu Firebase Authentication.`);
                 }
                return;
            }
            showAuthMessage("Iniciando sesi√≥n...", false);

            try {
                await fbAuth.setPersistence(persistence);
                const userCredential = await fbAuth.signInWithEmailAndPassword(email, password);
                // El observer onAuthStateChanged se encargar√° del resto (navegaci√≥n, carga de datos)
                // No es necesario llamar a showCalendarPage directamente aqu√≠ si onAuthStateChanged est√° bien configurado.
                localStorage.setItem('calendarRememberMe', rememberMeCheckbox.checked);

            } catch (error) {
                console.error("Error de inicio de sesi√≥n:", error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                     showAuthMessage('Email o contrase√±a incorrectos. Aseg√∫rate de que las cuentas de prueba existen en Firebase.', true);
                } else {
                    showAuthMessage('Error al iniciar sesi√≥n: ' + error.message, true);
                }
            }
        });

        // FIREBASE: Observer para el estado de autenticaci√≥n
        fbAuth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUserId = user.uid;
                showAuthMessage("Sesi√≥n iniciada.", false);
                setTimeout(() => authMessage.style.display = 'none', 1500);

                loginPage.style.display = 'none';
                // Decide qu√© vista mostrar. Por defecto, la anual.
                // Podr√≠as guardar la √∫ltima vista visitada en localStorage si quieres.
                calendarPage.style.display = 'flex';
                singleMonthViewPage.style.display = 'none';
                calendarPage.classList.add('fade-in');

                await loadDayEmojisFromFirestore(); // Carga los emojis del usuario
                generateCalendar(currentDisplayedYear); // Genera la vista anual por defecto

                if (currentDisplayedYear === new Date().getFullYear()) {
                    const currentMonthElement = document.getElementById('currentMonthCard');
                    if (currentMonthElement) {
                        setTimeout(() => currentMonthElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' }), 100);
                    }
                }
                 // Restaurar el estado del checkbox "Mantener sesi√≥n"
                const remembered = localStorage.getItem('calendarRememberMe') === 'true';
                rememberMeCheckbox.checked = remembered;

            } else {
                currentUserId = null;
                dayEmojis = {}; // Limpiar emojis locales al cerrar sesi√≥n

                loginPage.style.display = 'flex';
                calendarPage.style.display = 'none';
                singleMonthViewPage.style.display = 'none';
                monthModal.classList.remove('active');
                loginPage.classList.add('fade-in');
                hideEmojiPicker();
                emailInput.value = ''; // Limpiar campos de login
                passwordInput.value = '';
                showAuthMessage("Sesi√≥n cerrada o no iniciada.", false);
                setTimeout(() => authMessage.style.display = 'none', 2000);
            }
        });


        function handleLogout() {
            showAuthMessage("Cerrando sesi√≥n...", false);
            fbAuth.signOut().catch(error => {
                console.error("Error al cerrar sesi√≥n:", error);
                showAuthMessage("Error al cerrar sesi√≥n.", true);
            });
        }
        logoutButton.addEventListener('click', handleLogout);
        logoutButtonSingle.addEventListener('click', handleLogout);


        prevYearBtn.addEventListener('click', function() {
            currentDisplayedYear--;
            generateCalendar(currentDisplayedYear);
        });
        nextYearBtn.addEventListener('click', function() {
            currentDisplayedYear++;
            generateCalendar(currentDisplayedYear);
        });

        function switchToSingleMonthView() {
            calendarPage.style.display = 'none';
            singleMonthViewPage.style.display = 'flex';
            singleMonthViewPage.classList.add('fade-in');
            generateSingleMonthCalendar(currentSingleViewYear, currentSingleViewMonth);
            hideEmojiPicker();
        }

        function switchToAnnualView() {
            singleMonthViewPage.style.display = 'none';
            calendarPage.style.display = 'flex';
            calendarPage.classList.add('fade-in');
            generateCalendar(currentDisplayedYear);
            hideEmojiPicker();
            if (currentDisplayedYear === new Date().getFullYear()) {
                const currentMonthElement = document.getElementById('currentMonthCard');
                if (currentMonthElement) {
                    setTimeout(() => currentMonthElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' }), 100);
                }
            }
        }
        toggleViewButton.addEventListener('click', switchToSingleMonthView);
        toggleViewButtonSingle.addEventListener('click', switchToAnnualView);

        prevMonthSingleBtn.addEventListener('click', function() {
            currentSingleViewMonth--;
            if (currentSingleViewMonth < 0) {
                currentSingleViewMonth = 11;
                currentSingleViewYear--;
            }
            generateSingleMonthCalendar(currentSingleViewYear, currentSingleViewMonth);
        });
        nextMonthSingleBtn.addEventListener('click', function() {
            currentSingleViewMonth++;
            if (currentSingleViewMonth > 11) {
                currentSingleViewMonth = 0;
                currentSingleViewYear++;
            }
            generateSingleMonthCalendar(currentSingleViewYear, currentSingleViewMonth);
        });

        function openMonthModal(monthIndex, year) {
            modalTitle.textContent = `${meses[monthIndex]} ${year}`;
            generateModalCalendarGrid(monthIndex, year);
            monthModal.classList.add('active');
        }
        function closeMonthModal() {
            monthModal.classList.remove('active');
            hideEmojiPicker();
        }
        modalCloseButton.addEventListener('click', closeMonthModal);
        monthModal.addEventListener('click', function(event) {
            if (event.target === monthModal) closeMonthModal();
        });

        function populateEmojiPicker() {
            emojiPickerPanel.innerHTML = '';
            availableEmojis.forEach(emoji => {
                const emojiSpan = document.createElement('span');
                emojiSpan.textContent = emoji || 'üö´';
                emojiSpan.title = emoji ? emoji : "Borrar emoji";
                emojiSpan.addEventListener('click', () => selectEmoji(emoji));
                emojiPickerPanel.appendChild(emojiSpan);
            });
        }

        function showEmojiPicker(placeholderElement, dayKey, placeholderKey) {
            currentEditingPlaceholder = placeholderElement;
            currentEditingDayKey = dayKey;
            currentEditingPlaceholderKey = placeholderKey;
            const rect = placeholderElement.getBoundingClientRect();
            emojiPickerPanel.style.display = 'grid';
            let top = rect.bottom + window.scrollY + 5;
            let left = rect.left + window.scrollX - (emojiPickerPanel.offsetWidth / 2) + (rect.width / 2);
            emojiPickerPanel.style.top = `${top}px`;
            emojiPickerPanel.style.left = `${left}px`;
            const pickerRect = emojiPickerPanel.getBoundingClientRect();
            if (pickerRect.left < 0) emojiPickerPanel.style.left = '5px';
            else if (pickerRect.right > window.innerWidth) emojiPickerPanel.style.left = `${window.innerWidth - pickerRect.width - 5}px`;
            if (pickerRect.bottom > window.innerHeight && rect.top > pickerRect.height) {
                emojiPickerPanel.style.top = `${rect.top + window.scrollY - pickerRect.height - 5}px`;
            }
        }
        function hideEmojiPicker() {
            emojiPickerPanel.style.display = 'none';
            currentEditingPlaceholder = null; currentEditingDayKey = null; currentEditingPlaceholderKey = null;
        }

        function selectEmoji(emoji) {
            if (currentEditingPlaceholder && currentEditingDayKey && currentEditingPlaceholderKey) {
                if (!dayEmojis[currentEditingDayKey]) {
                    dayEmojis[currentEditingDayKey] = {};
                }
                if (emoji === '') {
                    currentEditingPlaceholder.textContent = '';
                    currentEditingPlaceholder.classList.remove('has-emoji');
                    delete dayEmojis[currentEditingDayKey][currentEditingPlaceholderKey];
                    if (Object.keys(dayEmojis[currentEditingDayKey]).length === 0) {
                        delete dayEmojis[currentEditingDayKey];
                    }
                } else {
                    currentEditingPlaceholder.textContent = emoji;
                    currentEditingPlaceholder.classList.add('has-emoji');
                    dayEmojis[currentEditingDayKey][currentEditingPlaceholderKey] = emoji;
                }
                // FIREBASE: Guardar el cambio espec√≠fico en Firestore
                saveEmojiForDayKeyToFirestore(currentEditingDayKey, dayEmojis[currentEditingDayKey]);
            }
            hideEmojiPicker();
        }

        document.addEventListener('click', function(event) {
            if (emojiPickerPanel.style.display === 'grid' &&
                !emojiPickerPanel.contains(event.target) &&
                currentEditingPlaceholder && !currentEditingPlaceholder.contains(event.target)) {
                hideEmojiPicker();
            }
        });

        function generateModalCalendarGrid(monthIndex, year) {
            modalCalendarGrid.innerHTML = '';
            const hoy = new Date();
            diasSemana.forEach(diaNombre => {
                const dayNameCell = document.createElement('div');
                dayNameCell.className = 'modal-day-name'; dayNameCell.textContent = diaNombre;
                modalCalendarGrid.appendChild(dayNameCell);
            });
            const primerDiaDelMesRaw = new Date(year, monthIndex, 1).getDay();
            const celdasVaciasInicio = (primerDiaDelMesRaw + 6) % 7;
            const diasEnMes = new Date(year, monthIndex + 1, 0).getDate();
            for (let i = 0; i < celdasVaciasInicio; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'modal-day-cell empty'; modalCalendarGrid.appendChild(emptyCell);
            }
            for (let dia = 1; dia <= diasEnMes; dia++) {
                const dayCell = document.createElement('div'); dayCell.className = 'modal-day-cell';
                const dayNumberSpan = document.createElement('span');
                dayNumberSpan.className = 'modal-day-number'; dayNumberSpan.textContent = dia;
                dayCell.appendChild(dayNumberSpan);
                const emojiArea = document.createElement('div'); emojiArea.className = 'emoji-display-area';
                const dayKey = `${year}-${String(monthIndex + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;

                const emojiPlaceholder1 = document.createElement('div'); emojiPlaceholder1.className = 'emoji-placeholder';
                const savedEmoji1 = dayEmojis[dayKey] && dayEmojis[dayKey]['placeholder1'];
                if (savedEmoji1) { emojiPlaceholder1.textContent = savedEmoji1; emojiPlaceholder1.classList.add('has-emoji'); }
                else { emojiPlaceholder1.textContent = 'üè†'; emojiPlaceholder1.classList.add('has-emoji'); }
                emojiPlaceholder1.addEventListener('click', (event) => { event.stopPropagation(); showEmojiPicker(emojiPlaceholder1, dayKey, 'placeholder1'); });
                emojiArea.appendChild(emojiPlaceholder1);

                const emojiPlaceholder2 = document.createElement('div'); emojiPlaceholder2.className = 'emoji-placeholder';
                const savedEmoji2 = dayEmojis[dayKey] && dayEmojis[dayKey]['placeholder2'];
                if (savedEmoji2) { emojiPlaceholder2.textContent = savedEmoji2; emojiPlaceholder2.classList.add('has-emoji'); }
                else {
                    const currentDateUTC = Date.UTC(year, monthIndex, dia);
                    if (currentDateUTC >= workSequenceStartDateOriginal) {
                        const timeDiff = currentDateUTC - workSequenceStartDateOriginal;
                        const dayDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
                        const sequenceIndex = dayDiff % workSequencePattern.length;
                        if (sequenceIndex >= 0) {
                           const workCode = workSequencePattern[sequenceIndex];
                            emojiPlaceholder2.textContent = workEmojisMap[workCode] || '';
                            if (workEmojisMap[workCode]) emojiPlaceholder2.classList.add('has-emoji');
                        } else { emojiPlaceholder2.textContent = ''; }
                    } else { emojiPlaceholder2.textContent = ''; }
                }
                emojiPlaceholder2.addEventListener('click', (event) => { event.stopPropagation(); showEmojiPicker(emojiPlaceholder2, dayKey, 'placeholder2'); });
                emojiArea.appendChild(emojiPlaceholder2);
                dayCell.appendChild(emojiArea);

                const diaDeSemanaActual = (celdasVaciasInicio + dia - 1) % 7;
                if (diaDeSemanaActual === 5 || diaDeSemanaActual === 6) dayCell.classList.add('weekend-day');
                if (isHoliday(year, monthIndex, dia)) dayCell.classList.add('holiday-day');
                if (monthIndex === hoy.getMonth() && dia === hoy.getDate() && year === hoy.getFullYear()) dayCell.classList.add('current-day');
                modalCalendarGrid.appendChild(dayCell);
            }
        }

        function generateSingleMonthCalendar(year, monthIndex) {
            singleMonthCalendarGrid.innerHTML = '';
            singleMonthYearDisplay.textContent = `${meses[monthIndex]} ${year}`;
            const hoy = new Date();
            diasSemana.forEach(diaNombre => {
                const dayNameCell = document.createElement('div');
                dayNameCell.className = 'single-month-day-name'; dayNameCell.textContent = diaNombre;
                singleMonthCalendarGrid.appendChild(dayNameCell);
            });
            const primerDiaDelMesRaw = new Date(year, monthIndex, 1).getDay();
            const celdasVaciasInicio = (primerDiaDelMesRaw + 6) % 7;
            const diasEnMes = new Date(year, monthIndex + 1, 0).getDate();
            for (let i = 0; i < celdasVaciasInicio; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'single-month-day-cell empty'; singleMonthCalendarGrid.appendChild(emptyCell);
            }
            for (let dia = 1; dia <= diasEnMes; dia++) {
                const dayCell = document.createElement('div'); dayCell.className = 'single-month-day-cell';
                const dayNumberSpan = document.createElement('span');
                dayNumberSpan.className = 'single-month-day-number'; dayNumberSpan.textContent = dia;
                dayCell.appendChild(dayNumberSpan);
                const emojiArea = document.createElement('div'); emojiArea.className = 'emoji-display-area';
                const dayKey = `${year}-${String(monthIndex + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;

                const emojiPlaceholder1 = document.createElement('div'); emojiPlaceholder1.className = 'emoji-placeholder';
                const savedEmoji1 = dayEmojis[dayKey] && dayEmojis[dayKey]['placeholder1'];
                if (savedEmoji1) { emojiPlaceholder1.textContent = savedEmoji1; emojiPlaceholder1.classList.add('has-emoji'); }
                else { emojiPlaceholder1.textContent = 'üè†'; emojiPlaceholder1.classList.add('has-emoji'); }
                emojiPlaceholder1.addEventListener('click', (event) => { event.stopPropagation(); showEmojiPicker(emojiPlaceholder1, dayKey, 'placeholder1'); });
                emojiArea.appendChild(emojiPlaceholder1);

                const emojiPlaceholder2 = document.createElement('div'); emojiPlaceholder2.className = 'emoji-placeholder';
                const savedEmoji2 = dayEmojis[dayKey] && dayEmojis[dayKey]['placeholder2'];
                if (savedEmoji2) { emojiPlaceholder2.textContent = savedEmoji2; emojiPlaceholder2.classList.add('has-emoji'); }
                else {
                    const currentDateUTC = Date.UTC(year, monthIndex, dia);
                     if (currentDateUTC >= workSequenceStartDateOriginal) {
                        const timeDiff = currentDateUTC - workSequenceStartDateOriginal;
                        const dayDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
                        const sequenceIndex = dayDiff % workSequencePattern.length;
                        if (sequenceIndex >= 0) {
                            const workCode = workSequencePattern[sequenceIndex];
                            emojiPlaceholder2.textContent = workEmojisMap[workCode] || '';
                            if (workEmojisMap[workCode]) emojiPlaceholder2.classList.add('has-emoji');
                        } else { emojiPlaceholder2.textContent = ''; }
                    } else { emojiPlaceholder2.textContent = ''; }
                }
                emojiPlaceholder2.addEventListener('click', (event) => { event.stopPropagation(); showEmojiPicker(emojiPlaceholder2, dayKey, 'placeholder2'); });
                emojiArea.appendChild(emojiPlaceholder2);
                dayCell.appendChild(emojiArea);

                const diaDeSemanaActual = (celdasVaciasInicio + dia - 1) % 7;
                if (diaDeSemanaActual === 5 || diaDeSemanaActual === 6) dayCell.classList.add('weekend-day');
                if (isHoliday(year, monthIndex, dia)) dayCell.classList.add('holiday-day');
                if (monthIndex === hoy.getMonth() && dia === hoy.getDate() && year === hoy.getFullYear()) dayCell.classList.add('current-day');
                singleMonthCalendarGrid.appendChild(dayCell);
            }
        }

        function generateCalendar(year) {
            calendarGrid.innerHTML = '';
            calendarYearDisplay.textContent = year;
            const hoy = new Date();
            meses.forEach((nombreMes, indiceMes) => {
                const monthCard = document.createElement('div'); monthCard.className = 'month-card';
                monthCard.addEventListener('click', () => openMonthModal(indiceMes, year));
                if (indiceMes === hoy.getMonth() && year === hoy.getFullYear()) monthCard.id = 'currentMonthCard';
                const monthHeader = document.createElement('h2');
                monthHeader.className = 'month-header'; monthHeader.textContent = nombreMes;
                monthCard.appendChild(monthHeader);
                const daysGridElement = document.createElement('div'); daysGridElement.className = 'days-grid';
                diasSemana.forEach(diaNombre => {
                    const dayNameCell = document.createElement('div');
                    dayNameCell.className = 'day-name'; dayNameCell.textContent = diaNombre;
                    daysGridElement.appendChild(dayNameCell);
                });
                const primerDiaDelMesRaw = new Date(year, indiceMes, 1).getDay();
                const celdasVaciasInicio = (primerDiaDelMesRaw + 6) % 7;
                const diasEnMes = new Date(year, indiceMes + 1, 0).getDate();
                for (let i = 0; i < celdasVaciasInicio; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'day-cell empty'; daysGridElement.appendChild(emptyCell);
                }
                for (let dia = 1; dia <= diasEnMes; dia++) {
                    const dayCell = document.createElement('div'); dayCell.className = 'day-cell';
                    dayCell.textContent = dia;
                    const diaDeSemanaActual = (celdasVaciasInicio + dia - 1) % 7;
                    if (diaDeSemanaActual === 5 || diaDeSemanaActual === 6) dayCell.classList.add('weekend-day');
                    if (isHoliday(year, indiceMes, dia)) dayCell.classList.add('holiday-day');
                    if (indiceMes === hoy.getMonth() && dia === hoy.getDate() && year === hoy.getFullYear()) dayCell.classList.add('current-day');
                    daysGridElement.appendChild(dayCell);
                }
                monthCard.appendChild(daysGridElement);
                calendarGrid.appendChild(monthCard);
            });
        }

        // --- INICIALIZACI√ìN ---
        populateEmojiPicker();
        // La carga inicial de emojis y la visualizaci√≥n del calendario se manejan por onAuthStateChanged.

    </script>
</body>
</html>
